@page "/borrowing-history"
@model LibararyWebApplication.Pages.Student.BorrowingHistoryModel
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

<div class="container mt-4">
    <h2 class="text-warning">Lịch sử đặt mượn sách</h2>
    
    @if (Model.Message != null)
    {
        <div class="alert alert-info">@Model.Message</div>
    }

    @if (Model.Borrowings.Count > 0)
    {
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>STT</th>
                        <th>Tên sách</th>
                        <th>Ngày mượn</th>
                        <th>Hạn trả</th>
                        <th>Trạng thái</th>
                        <th>Số lần gia hạn</th>
                    </tr>
                </thead>    
                <tbody>
                    @for (int i = 0; i < Model.Borrowings.Count; i++)
                    {
                        var item = Model.Borrowings[i];
                        var isOverdue = item.DueDate < DateTime.Now && item.Status == "borrowed";
                        var rowClass = isOverdue ? "table-danger" : "";
                        
                        <tr class="@rowClass">
                            <td>@(i + 1)</td>
                            <td><strong>@item.BookTitle</strong></td>
                            <td>@item.RentalDate.ToString("dd/MM/yyyy")</td>
                            <td>
                                @if (isOverdue)
                                {
                                    <span class="text-danger font-weight-bold">@item.DueDate.ToString("dd/MM/yyyy") (Quá hạn)</span>
                                }
                                else
                                {
                                    @item.DueDate.ToString("dd/MM/yyyy")
                                }
                            </td>
                            <td>
                                @if (item.Status == "borrowed")
                                {
                                    <span class="badge bg-primary">Đang mượn</span>
                                }
                                else if (item.Status == "returned")
                                {
                                    <span class="badge bg-success">Đã trả</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">@item.Status</span>
                                }
                            </td>
                            <td>@item.RenewCount</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div class="row mt-3">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Thống kê</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>Tổng số sách đã mượn:</strong> @Model.Borrowings.Count</p>
                        <p><strong>Sách đang mượn:</strong> @Model.Borrowings.Count(b => b.Status == "borrowed")</p>
                        <p><strong>Sách đã trả:</strong> @Model.Borrowings.Count(b => b.Status == "returned")</p>
                        <p><strong>Sách quá hạn:</strong> @Model.Borrowings.Count(b => b.DueDate < DateTime.Now && b.Status == "borrowed")</p>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-info">
            <h4>Chưa có lịch sử mượn sách</h4>
            <p>Bạn chưa mượn sách nào từ thư viện.</p>
            <a href="/borrowing?userId=@Model.UserId" class="btn btn-primary">Mượn sách ngay</a>
        </div>
    }

    <div class="mt-3">
        <a href="/borrowing?userId=@Model.UserId" class="btn btn-warning">
            <i class="fa fa-arrow-left"></i> Quay lại trang mượn sách
        </a>
    </div>
</div> 